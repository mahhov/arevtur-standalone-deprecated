<style>
	#results-container {
		display: flex;
		align-items: flex-start;
		margin-top: 30px;
	}

	progress[value="1"] {
		display: none;
	}

	#results-list {
		flex: 1;
	}

	#results-list .item {
		margin: 10px;
	}
</style>

<script>
	require('./xElements/import');
</script>

<x-inputs></x-inputs>
<div id="results-container">
	<div>Count: <span id="results-count"></span></div>
	<progress id="results-progress-bar" max="1" value="1"></progress>
	<div id="results-progress-text"></div>
	<div id="results-list"></div>
	<x-chart id="results-chart" width="600" height="600"></x-chart>
</div>

<script>
	const {XElement} = require('xx-element');
	const DataFetcher = require('./DataFetcher');
	const ItemsData = require('./ItemsData');

	const $ = document.querySelector.bind(document);
	const $$ = document.querySelectorAll.bind(document);
	const $c = (tag, classList = [], text = '', parent = null) => {
		let el = document.createElement(tag);
		el.classList.add(...classList);
		el.textContent = text;
		if (parent)
			parent.appendChild(el);
		return el;
	};

	let submitQuery = async query => {
		// todo split into renderOutput
		let items = await DataFetcher.getItems(query, (text, ratio) => {
			$('#results-progress-bar').value = ratio;
			$c('div', [], text, $('#results-progress-text'));
		});
		itemsData.join(items);
	};

	let renderItemsData = (itemsData, resetChartRange = false) => {
		renderItemsDataList(itemsData);
		renderItemsDataChart(itemsData, resetChartRange);
	};

	let renderItemsDataList = itemsData => {
		XElement.clearChildren($('#results-progress-text'));

		$('#results-count').textContent = itemsData.length;

		XElement.clearChildren($('#results-list'));
		itemsData.items.forEach(itemData => {
			let itemListing = $c('x-item-listing', ['item'], '', $('#results-list'));
			itemListing.addEventListener('click', () => {
				itemsData.select(itemData);
				itemListing.itemData = itemData;
				renderItemsDataChart(itemsData);
			});
			itemListing.itemData = itemData;
		});
	};

	let renderItemsDataChart = (itemsData, resetChartRange = false) => {
		$('#results-chart').background = 'rgb(245,245,245)';
		$('#results-chart').pointSets = [
			{
				color: 'rgb(255,255,255)',
				fill: true,
				size: 1,
				points: itemsData.searchBoundPath,
				isPath: true,
			}, {
				color: 'rgb(0,0,255)',
				size: 1,
				points: itemsData.bestBoundPath,
				isPath: true,
			}, {
				color: 'rgb(0,0,0)',
				fill: true,
				size: 4,
				points: ItemsData.itemsToPoints(itemsData.items),
			}, {
				color: 'rgb(0,0,255)',
				size: 8,
				points: ItemsData.itemsToPoints(itemsData.bestBoundItems),
			}, {
				color: 'rgb(170,170,0)',
				size: 8,
				points: ItemsData.itemsToPoints(itemsData.selectedItems),
			},
		];
		if (resetChartRange)
			$('#results-chart').resetRange();
	};

	let itemsData = new ItemsData();
	$('x-inputs').addEventListener('submit', async e => {
		if (!e.detail.add)
			itemsData.clear();
		await Promise.all($('x-inputs')
			.getQueries()
			.map(submitQuery));
		renderItemsData(itemsData, true);
	});

	// todo submit query verify
	$('#results-chart').addEventListener('action-click', async e => {
		await Promise.all($('x-inputs')
			.getQueries(e.detail.x || null)
			.map(submitQuery));
		renderItemsData(itemsData);
	})

	// todo
	// items sometimes coming back without pseudo mod 'Sum: '
	// hover and select result list and chart
	// sharing filter groups
	// submit query on load
	// query by name
	// convert armor and socket requirements to fuzzy query
	// assume quality 0%
	// free affixes
	// search results text
	// x-model setter on same value
	// default query property filter
	// pin item list

</script>
