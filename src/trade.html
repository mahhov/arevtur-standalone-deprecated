<style>
	#query-container {
		background: #f8f8f8;
		padding: 10px;
	}

	#query-type {
		width: 300px;
	}

	#query-value, #query-price {
		width: 60px;
	}

	#query-properties-list x-query-property.dragging {
		outline: 1px solid black;
	}

	#results-container {
		display: flex;
		align-items: flex-start;
		margin-top: 30px;
	}

	#results-list {
		flex: 1;
	}

	#results-list .item {
		margin: 10px;
	}
</style>

<div id="query-container">
	<div>
		<x-autocomplete-input id="query-type" placeholder="type"></x-autocomplete-input>
		<input id="query-value" type="number" placeholder="value">
		<input id="query-price" type="number" placeholder="price">
	</div>
	<x-arrangable-list id="query-properties-list"></x-arrangable-list>
	<div>
		<button id="query-add-property">add</button>
		<button id="query-submit">submit</button>
	</div>
</div>

<div id="results-container">
	<div id="results-progress"></div>
	<div id="results-list"></div>
	<x-chart id="results-chart" width="400" height="400"></x-chart>
</div>

<script>
	require('./xElements/import');
	const {XElement} = require('xx-element');
	const ApiConstants = require('./ApiConstants');
	const DataFetcher = require('./DataFetcher');

	const $ = document.querySelector.bind(document);
	const $$ = document.querySelectorAll.bind(document);
	const $c = (tag, classList = [], text = '', parent = null) => {
		let el = document.createElement(tag);
		el.classList.add(...classList);
		el.textContent = text;
		if (parent)
			parent.appendChild(el);
		return el;
	};

	let queryPropertyIds = Object.values(ApiConstants.PROPERTIES)
		.flat()
		.map(property => property.id);

	let submitQuery = async () => {
		let type = $('#query-type').value;
		let minValue = $('#query-value').value;
		let maxPrice = $('#query-price').value;
		if (!type || !minValue || !maxPrice)
			return;

		let weightEntries = [...$$('#query-properties-list x-query-property')]
			.map(queryProperty => [queryProperty.property, queryProperty.weight])
			.filter(([a, b]) => queryPropertyIds.includes(a) && b);
		if (!weightEntries.length)
			return;
		let weights = Object.fromEntries(weightEntries);

		localStorage.setItem('last-query-inputs', JSON.stringify({type, minValue, maxPrice, weightEntries}));

		let query = DataFetcher.formQuery(type, weights, minValue, maxPrice);
		let itemsData = await DataFetcher.getItems(query, progress =>
			$c('div', [], progress, $('#results-progress')));
		XElement.clearChildren($('#results-progress'));

		let itemsToPoints = items =>
			items.map(item => ({x: item.evalPrice, y: item.evalValue}));

		$('#results-chart').pointSets = [
			{
				color: 'rgb(0,0,0)',
				size: 4,
				points: itemsToPoints(itemsData.items),
			}, {
				color: 'rgb(0,0,255)',
				size: 6,
				points: itemsToPoints(itemsData.borderlineItems),
			},
		];

		XElement.clearChildren($('#results-list'));
		itemsData.items.forEach(itemData =>
			$c('x-item-listing', ['item'], '', $('#results-list')).itemData = itemData);
	};

	$('#query-type').autocompletes = Object.values(ApiConstants.TYPES);

	let addQueryProperty = () => {
		let queryProperty = document.createElement('x-query-property');
		queryProperty.properties = queryPropertyIds;
		queryProperty.slot = 'list';
		$('#query-properties-list').appendChild(queryProperty);
		queryProperty.addEventListener('change', () => {
			if (queryProperty === $('#query-properties-list').lastChild && !queryProperty.empty)
				addQueryProperty();
		});
		queryProperty.addEventListener('remove', () => queryProperty.remove());
		return queryProperty;
	};

	$('#query-add-property').addEventListener('click', () => addQueryProperty());

	$('#query-submit').addEventListener('click', submitQuery);

	let lastQueryInputs = JSON.parse(localStorage.getItem('last-query-inputs')) || {weightEntries: []};
	$('#query-type').value = lastQueryInputs.type;
	$('#query-value').value = lastQueryInputs.minValue;
	$('#query-price').value = lastQueryInputs.maxPrice;
	lastQueryInputs.weightEntries
		.forEach(([property, weight]) => {
			let queryProperty = addQueryProperty();
			queryProperty.property = property;
			queryProperty.weight = weight;
		});
	addQueryProperty();
	// submitQuery(); // todo restore all query inputs and submit query on load

	// todo
	// lock filter weights with above weights
	// some AND and NOT filters (e.g. & 30 move speed; & not can't use body)
	// multiple queries and sharing filter groups
	// query by name
	// expand price range
	// convert armor and socket requirements to fuzzy query
	// assume quality 0%
	// free affixes

</script>
